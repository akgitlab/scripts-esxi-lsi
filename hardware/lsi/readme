Шаблон для мониторинга RAID контроллеров LSI (Broadcom, Avago).


Мониторинг осуществляется с помощью утилиты storcli, запускаемой со стороны сервера мониторинга.
Ничего не мешает сделать тоже самое в прочих ОС - нужно только установить утилиту storcli и
использовать ее возможности вывода данных в формате JSON.


В шаблоне используется низкоуровневое обнаружение LLD и создаются следующие элементы данных:

controllers — контроллеры;
logical disc — логические диски;
physical discs — физические диски в Enclosure и Backplane;
physical discs ne — физические диски без Enclosure и Backplane;
cv — кэш с батарейкой;
bbu — батарейки.


1) На хосте с ESXi XX.XX создать локального пользователя zabbix | pa$$w0rd


2) Создать на хосте каталог для хранения ключа авторизации этого пользователя

shell> mkdir /etc/ssh/keys-zabbix


3) Отредактировать файл для авторизации zabbix

shell> vi /etc/security/access.conf
...
+:zabbix:ALL
...
Возможна проблема в том, что access.conf сбрасывается не только после перезагрузки, но и после создания пользователей, ролей и т. д. 
поэтому придется добавлять его восстановление в начальную загрузку, например через /etc/rc.local (если ESXi 4.x или ESXi 5.0) 
или в /etc/rc.local.d/local.sh (если ESXi 5.1+).


4) Скопировать публичный ключ с сервера мониторинга на хост

shell> sudo scp /var/lib/zabbix/.ssh/id_rsa.pub root@{HOST.IP}:/etc/ssh/keys-zabbix/authorized_keys


5) Проверить загрузку данных с хоста в формате JSON на сервер мониторинга

shell> sudo ssh -i /var/lib/zabbix/.ssh/id_rsa zabbix@{HOST.IP} '/opt/lsi/storcli/storcli /c0 show all j'


6) На сервере мониторинга создаем файл конфигурации

shell> sudo nano /etc/zabbix/zabbix_agentd.d/lsimr.conf
UserParameter=lsimr.ctl.info[*],sudo /etc/zabbix/scripts/lsimr-ctl-info.sh $1 $2
UserParameter=lsimr.ctl.cvs.info[*],sudo /etc/zabbix/scripts/lsimr-cvs-info.sh $1 $2
UserParameter=lsimr.ctl.bbu.info[*],sudo /etc/zabbix/scripts/lsimr-bbu-info.sh $1 $2
UserParameter=lsimr.vd.info[*],sudo /etc/zabbix/scripts/lsimr-vd-info.sh $1 $2
UserParameter=lsimr.pd.info[*],sudo /etc/zabbix/scripts/lsimr-pd-info.sh $1 $2
UserParameter=lsimr.pd.ne.info[*],sudo /etc/zabbix/scripts/lsimr-pd-info-ne.sh $1 $2
UserParameter=lsimr.pd.all.info[*],sudo /etc/zabbix/scripts/lsimr-pd-info-all.sh $1 $2
UserParameter=lsimr.pd.ne.all.info[*],sudo /etc/zabbix/scripts/lsimr-pd-info-all.sh $1 $2
